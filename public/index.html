<!-- public/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WASM Quantum State Vector Simulator (C++/pthreads)</title>
  <link rel="stylesheet" href="style.css" />
  <script>
    console.log('[index.html] main script start');
    window.addEventListener('error', (e) => console.error('[window error]', e));
    // Ensure the main runtime runs in a Worker so we can block & use pthreads comfortably.
    // Also set the pthread pool size dynamically.
    window.Module = {
      // You can tweak this before loading sim.js
      pthreadPoolSize: (navigator.hardwareConcurrency ? Math.max(2, Math.min(navigator.hardwareConcurrency, 8)) : 4),
      onRuntimeInitialized() {
        console.log('[index.html] wasm runtime initialized');
        Module.runtimeInitialized = true;
        document.dispatchEvent(new Event('wasm-ready'));
      },
      // Make sure resource paths (wasm/worker) resolve next to sim.js
      locateFile: (path) => path,
    };
    console.log('[index.html] Module config', window.Module);
  </script>
</head>
<body>
  <header>
    <h1>WASM Quantum State Vector Simulator</h1>
    <div class="pill">C++ → WebAssembly / Shared-memory parallel (pthread)</div>
  </header>

  <main>
    <section class="card">
      <h2>Initialization</h2>
      <div class="row">
        <label>Number of qubits: <input id="nQubits" type="number" min="1" max="28" value="18" /></label>
        <label>Number of threads: <input id="nThreads" type="number" min="1" max="16" value="4" /></label>
        <button id="btnInit">Initialize</button>
        <button id="btnReset">Reset to |0…0⟩</button>
      </div>
      <p id="xo-warning" class="warn" hidden>
        This page is not <code>crossOriginIsolated</code>.<br>
        To use SharedArrayBuffer and pthreads, the server must send
        <code>Cross-Origin-Opener-Policy: same-origin</code> and
        <code>Cross-Origin-Embedder-Policy: require-corp</code> headers.
      </p>
    </section>

    <section class="card">
      <h2>Apply Gate</h2>
      <div class="row">
        <label>Target q: <input id="targetQ" type="number" min="0" value="0" /></label>
        <label>Control q (for CNOT): <input id="controlQ" type="number" min="0" value="1" /></label>
      </div>
      <div class="row gates">
        <button data-g="H">H</button>
        <button data-g="X">X</button>
        <button data-g="RX">RX(θ)</button>
        <button data-g="RY">RY(θ)</button>
        <button data-g="RZ">RZ(θ)</button>
        <input id="theta" type="number" step="0.01" value="1.57079632679" />
        <button data-g="CNOT">CNOT</button>
      </div>
    </section>

    <section class="card">
      <h2>Probability Preview</h2>
      <div class="row">
        <label>Display count (from start) <input id="viewCount" type="number" min="2" max="65536" value="4096" /></label>
        <button id="btnRefresh">Refresh</button>
        <button id="btnOneShot">One-shot measurement</button>
        <span id="shotOut"></span>
      </div>
      <div id="probs"></div>
    </section>
  </main>

  <footer>
    <small>© MIT License / Demo</small>
  </footer>

  <script type="module">
    import createModule from './sim.js';
    console.log('[index.html] creating module');
    // Instantiate the modularized WASM and expose it globally
    window.Module = await createModule(window.Module);
    console.log('[index.html] Module created', window.Module);
    console.log('[index.html] importing app.js');
    // Load the application logic once the runtime is ready
    await import('./app.js');
    console.log('[index.html] app.js imported');
  </script>
</body>
</html>
